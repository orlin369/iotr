<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="style.min.css" rel="stylesheet" type="text/css">
        <title>IoTR - SETTINGS</title>
    </head>
    <body class="with-fixed-menu">
        <input type="checkbox" class="hidden" id="nav-toggle" autocomplete="off">
        <div class="nav fixed grid-container">
            <div class="col xs-no md-1"></div>
            <div class="col xs-12 sm-7 md-6">
                <span class="logo">IoTR&nbsp;|</span>
                <ul>
                    <li><a href="/dashboard" class="link">Dashboard</a></li>
                    <li><a href="/settings" class="link">Settings</a></li>
                    <li class="active"><a href="/network" class="link">Network</a></li>
                    <li><a href="/mqtt" class="link">MQTT</a></li>
                    <li><a href="#" class="link">Help</a></li>
                    <li><a href="/logout" class="link">Logout</a></li>
                </ul>
            </div>
            <div class="col xs-12 sm-3 md-4 text-right">
                <div class="head-right">
                    <span id="clock">00.00.0000/00:00:00</span>
                    <span>|</span>
                    <span>127.0.0.1</span>
                </div>
            </div>
            <div class="col xs-no md-1">
            </div>
        </div>
        <label for="nav-toggle"></label>
        <div class="grid-container">
            <div class="row">
                <div class="col xs-no md-3"></div>
                <div class="col xs-12 md-6">
                    <form action="" method="post" class="section">
                        <fieldset>
                            <legend>Info</legend>
                            <div class="grid-container">
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <span class="form-label">SSID:</span>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <div id="x_ssid" class="form-label"></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <span class="form-label">IP:</span>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <div id="x_ip" class="form-label"></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <span class="form-label">Net Mask:</span>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <div id="x_netmask" class="form-label"></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <span class="form-label">Gateway:</span>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <div id="x_gateway" class="form-label"></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <span class="form-label">DNS:</span>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <div id="x_dns" class="form-label"></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <span class="form-label">MAC:</span>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <div id="x_mac" class="form-label"></div>
                                    </div>
                                </div>
                        </fieldset>
                    </form>
                    <form action="" method="post" class="section">
                        <fieldset>
                            <legend>Network</legend>
                            <div class="grid-container">
                                <!--Connection State-->
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <label class="form-label">State:</label>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <div id="connectionstate" class="form-label">N/A</div>
                                    </div>
                                </div>
                                <!--Networks-->
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <label class="form-label">Networks:</label>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <span id="numNets" class="form-label">0</span>
                                    </div>
                                </div>
                                <!--Table Networks-->
                                <div class="row">
                                    <table class="form-control">
                                        <thead class="form-control">
                                            <tr>
                                                <th>SSID</th>
                                                <th>Channel</th>
                                                <th>Secure</th>
                                                <th>RSSI</th>
                                            </tr>
                                        </thead>
                                        <tbody id="networks"></tbody>
                                    </table>
                                </div>
                                <!-- Refresh network list. -->
                                <div class="row">
                                    <div class="col xs-12 md-8">
                                        <a href="javascript:getConnectionState(); getNetwork();" class="btn btn--m btn--blue">Refresh</a>
                                    </div>
                                </div>
                                <!--SSID-->
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <label for="ssid" class="form-label">SSID:</label>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <input type="text" id="ssid" name="ssid" class="form-control" placeholder="SSID" required="required"/>
                                    </div>
                                </div>
                                <!--PASS-->
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <label for="password" class="form-label">Password</label>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <input type="password" id="password" name="password" class="form-control" placeholder="Password" required="required"/>
                                    </div>
                                </div>
                                <!-- Save -->
                                <div class="row">
                                    <input type="submit" class="form-control" value="Save">
                                </div>
                            </div>
                        </fieldset>
                    </form>
                    <form action="" method="post" class="section">
                        <fieldset>
                            <legend>Static Network</legend>
                            <div class="grid-container">
                                <!--DHCP-->
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <label for="dhcp" class="form-label">DHCP:</label>
                                    </div>
                                    <div class="col xs-12 md-8">
                                        <input type="checkbox" id="dhcp" name="dhcp" class="form-control" placeholder="15" />
                                    </div>
                                </div>
                                <!--IP-->
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <label class="form-label">IP:</label>
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="ip_0" name="ip_0" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="ip_1" name="ip_1" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="ip_2" name="ip_2" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="ip_3" name="ip_3" class="form-control" required="required">
                                    </div>
                                </div>
                                <!--Net Mask-->
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <label class="form-label">Net Mask:</label>
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="nm_0" name="nm_0" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="nm_1" name="nm_1" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="nm_2" name="nm_2" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="nm_3" name="nm_3" class="form-control" required="required">
                                    </div>
                                </div>
                                <!--Gateway-->
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <label class="form-label">Gateway:</label>
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="gw_0" name="gw_0" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="gw_1" name="gw_1" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="gw_2" name="gw_2" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="gw_3" name="gw_3" class="form-control" required="required">
                                    </div>
                                </div>
                                <!--DNS-->
                                <div class="row">
                                    <div class="col xs-12 md-3 text-right">
                                        <label class="form-label">DNS:</label>
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="dns_0" name="dns_0" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="dns_1" name="dns_1" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="dns_2" name="dns_2" class="form-control" required="required">
                                    </div>
                                    <div class="col xs-12 md-2">
                                        <input type="text" id="dns_3" name="dns_3" class="form-control" required="required">
                                    </div>
                                </div>
                                <!-- Save -->
                                <div class="row">
                                    <input type="submit" class="form-control" value="Save">
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div class="row footer">
                    <div class="col xs-no md-1"></div>
                    <div class="col xs-12 md-10 footer text-center-xs">
                        <p style="padding-top: 10px;"><strong>IoTR</strong> was designed and built by Orlin Dimitrov.</p>
                    </div>
                </div>
            </div>
        </div>
        <script language="javascript" type="text/javascript" src="/microajax.js"></script>
        <!-- Javascript test -->
        <script language='javascript' type='text/javascript'>

            function formatTwoDigits(i) {
                if (i < 10) {i = '0' + i};// add zero in front of numbers < 10
                return i;
            }

            function startTime() {
                var today = new Date();
                var years = today.getFullYear();
                var month = today.getMonth();
                var date = today.getDate();
                var hours = today.getHours();
                var minutes = today.getMinutes();
                var seconds = today.getSeconds();

                date = formatTwoDigits(date);
                month = formatTwoDigits(month);
                hours = formatTwoDigits(hours);
                minutes = formatTwoDigits(minutes);
                seconds = formatTwoDigits(seconds);

                var clockText = date + '.' + month + '.' + years + '/' + hours + ':' + minutes + ':' + seconds;
                document.getElementById('clock').innerHTML = clockText;

                var t = setTimeout(startTime, 500);
            }

            function getInfoValues() {
                setValues('/api/v1/conninfo');
            }

            function getNetworkValues() {
                setValues('/api/v1/netcfg');
            }

            function setSSID(value) {
                document.getElementById('ssid').value = value;
            }

            function getNetwork() {

                function securityStr(security) {
                    if (security == 7) {
                        return 'Open';
                    }
                    else if (security == 5) {
                        return 'WEP';
                    }
                    else if (security == 2) {
                        return 'WPA';
                    }
                    else if (security == 4) {
                        return 'WPA2';
                    }
                    else if (security == 8) {
                        return 'WPA/WPA2';
                    }
                }

                function setSSID(value) {
                    document.getElementById('ssid').value = value;
                }

                function wifiScan(res) {
                    var array;

                    if (!res || (res.target.responseText == '[]')) {
                        setTimeout(function () { getNetwork(); }, 5000);
                        return;
                    }

                    array = JSON.parse(res.target.responseText);
                    array.sort(function (a, b) { return a.rssi - b.rssi });
                    array.reverse();
                    document.getElementById('numNets').innerHTML = array.length;
                    var table = document.getElementById('networks');
                    table.innerHTML = '';
                    for (var i = 0; i < array.length; i++) {
                        var row = document.createElement('tr');
                        row.innerHTML = '<td>' + '<a href=javascript:setSSID(\'' + array[i].ssid + '\');>' + array[i].ssid + '</a></td>'+
                        '<td>' + array[i].channel + '</td>'+
                        '<td>' + securityStr(array[i].secure) + '</td>'+
                        '<td>' + array[i].rssi + '</td>';
                        table.appendChild(row);
                    }
                }

            request = new XMLHttpRequest();
            if (request) {
                request.open('GET', '/api/v1/scan', true);
                request.addEventListener('load', wifiScan);
                request.send();
            }
        }

            function getConnectionState() {
                setValues('/api/v1/connstate');
            }

            window.onload = function () {
                
                startTime();
                setTimeout(getInfoValues, 500);
                setTimeout(getNetworkValues(), 1500);
                setTimeout(getConnectionState, 2000);
                setTimeout(getNetwork, 2500);
            }
        </script>
    </body>
</html>
